// prisma/schema.prisma
// HCS-U7 Admin Dashboard Database Schema
// Copyright (c) 2025 Benjamin BARRERE / IA SOLUTION
// Patent Pending FR2514274 | CC BY-NC-SA 4.0

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// TENANTS (Clients HCS-U7)
// ========================================
model Tenant {
  id        String  @id @default(cuid())
  email     String  @unique
  fullName  String
  company   String?
  website   String?

  // üîê Authentication
  passwordHash       String?          // Required for login (null = not yet set)
  hcsCodeHash        String?          // Optional HCS-U7 cognitive 2FA
  mustChangePassword Boolean @default(true)

  // Plan & billing
  plan   Plan         @default(STARTER)
  status TenantStatus @default(TRIAL)

  // Quotas
  monthlyQuota Int @default(10000)
  currentUsage Int @default(0)

  // Dates
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  trialEndsAt           DateTime?
  subscriptionStartedAt DateTime?

  // Metadata (use case, estimated volume, source, etc.)
  metadata      Json?
  internalNotes String?

  // Relations
  apiKeys       ApiKey[]
  billingEvents BillingEvent[]
  usageLogs     UsageLog[]

  @@index([email])
  @@index([status])
  @@index([plan])
  @@map("tenants")
}

// ========================================
// API KEYS
// ========================================
model ApiKey {
  id            String      @id @default(cuid())
  keyHash       String      @unique
  keyPrefix     String      // "hcs_sk_live_" or "hcs_sk_test_"
  lastFourChars String      // For masked display
  name          String?     // "Production API", "Staging", etc.
  environment   Environment @default(PRODUCTION)
  tenantId      String
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  lastUsedAt    DateTime?
  expiresAt     DateTime?
  scopes        String[]    // ["verify", "generate", "auth", "admin"]
  rateLimit     Int?        // Requests per minute
  tenant        Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([keyHash])
  @@index([environment])
  @@map("api_keys")
}

// ========================================
// USAGE LOGS (API Consumption)
// ========================================
model UsageLog {
  id           String   @id @default(cuid())
  tenantId     String
  endpoint     String   // "/v1/verify", "/v1/generate"
  method       String   // "POST", "GET"
  statusCode   Int      // 200, 401, 429, 500
  billable     Boolean  @default(true)
  cost         Float?   // Cost of this request (ex: 0.004‚Ç¨)
  ipAddress    String?
  userAgent    String?
  responseTime Int?     // Response time in ms
  errorMessage String?
  createdAt    DateTime @default(now())
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@index([endpoint])
  @@index([statusCode])
  @@map("usage_logs")
}

// ========================================
// BILLING EVENTS (Invoicing)
// ========================================
model BillingEvent {
  id                    String           @id @default(cuid())
  tenantId              String
  type                  BillingEventType
  amount                Float            // In euros
  currency              String           @default("EUR")
  periodStart           DateTime
  periodEnd             DateTime
  stripeInvoiceId       String?
  stripePaid            Boolean          @default(false)
  stripePaymentIntentId String?
  description           String?
  metadata              Json?
  createdAt             DateTime         @default(now())
  paidAt                DateTime?
  dueDate               DateTime?
  tenant                Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, createdAt])
  @@index([type])
  @@index([stripePaid])
  @@map("billing_events")
}

// ========================================
// ACCESS REQUESTS (Prospect applications)
// ========================================
model AccessRequest {
  id String @id @default(cuid())

  // Prospect info
  email    String
  fullName String
  company  String

  // Business info
  useCase         String  // "banking" | "ecommerce" | "api" | "other"
  estimatedVolume String  // "1k-10k" | "10k-100k" | "100k-1M" | "1M+"
  message         String?

  // HCS Code (stored temporarily, not hashed)
  hcsCode String

  // Status workflow
  status RequestStatus @default(PENDING)

  // Tracking
  ipAddress String
  userAgent String

  // Stripe
  stripeCheckoutUrl String?  // Lien Stripe unique g√©n√©r√©
  stripeSessionId   String?  // Session ID Stripe
  stripePaid        Boolean  @default(false)

  // Admin actions
  approvedBy     String?   // AdminUser.id who approved
  approvedAt     DateTime?
  rejectedReason String?
  adminNotes     String?

  // Relation Tenant cr√©√©
  tenantId String? // Tenant.id apr√®s cr√©ation

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([email])
  @@index([createdAt])
  @@index([stripeSessionId])
  @@map("access_requests")
}

// ========================================
// ADMIN USERS (Dashboard access)
// ========================================
model AdminUser {
  id                  String               @id @default(cuid())
  email               String               @unique
  passwordHash        String
  role                AdminRole            @default(VIEWER)
  fullName            String?
  avatarUrl           String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  lastLoginAt         DateTime?
  passwordResetTokens PasswordResetToken[]

  @@index([email])
  @@index([role])
  @@map("admin_users")
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  adminId   String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  admin     AdminUser @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([adminId, expiresAt])
  @@map("password_reset_tokens")
}

// ========================================
// AUDIT LOGS (Admin action traceability)
// ========================================
model AuditLog {
  id          String   @id @default(cuid())
  adminUserId String
  adminEmail  String
  action      String   // "CLIENT_CREATED", "API_KEY_GENERATED", "PLAN_CHANGED", "ACCESS_REQUEST_APPROVED"
  entityType  String   // "Tenant", "ApiKey", "BillingEvent", "AccessRequest"
  entityId    String   // ID of modified entity
  changes     Json?    // Before/after
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  @@index([adminUserId, createdAt])
  @@index([action])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

// ========================================
// ENUMS
// ========================================

enum Plan {
  FREE       // Legacy - kept for backward compatibility
  STARTER
  PRO
  BUSINESS
  ENTERPRISE
}

enum TenantStatus {
  TRIAL      // Active trial period
  ACTIVE     // Active paid subscription
  SUSPENDED  // Quota exceeded or payment failed
  CANCELLED  // Customer cancelled
  CHURNED    // Inactive for >60 days
}

enum Environment {
  PRODUCTION
  STAGING
  DEVELOPMENT
}

enum BillingEventType {
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_RENEWED
  OVERAGE_CHARGE
  PLAN_UPGRADED
  PLAN_DOWNGRADED
  REFUND
  PAYMENT_FAILED
  TRIAL_STARTED
  TRIAL_ENDED
}

enum RequestStatus {
  PENDING          // En attente d'examen admin
  APPROVED         // Approuv√©, lien Stripe envoy√©
  PAID             // Prospect a pay√©
  TENANT_CREATED   // Tenant cr√©√©, email envoy√©
  REJECTED         // Rejet√© par admin
}

enum AdminRole {
  SUPER_ADMIN  // Everything (Benjamin)
  ADMIN        // Client + key management
  SUPPORT      // Read + client notes
  VIEWER       // Read-only analytics
}
